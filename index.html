<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; frame-src https://www.youtube.com; style-src 'self' 'unsafe-inline'; connect-src 'self' https://*.googleapis.com;">
    <title>Killtime</title>
    <style>
        :root {
            --primary-color: #1DB954;
            --bg-color: #121212;
            --text-color: #FFFFFF;
            --secondary-bg: #282828;
        }

        body {
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: var(--bg-color);
            color: var(--text-color);
            overflow-x: hidden;
            touch-action: manipulation;
        }

        .container {
            max-width: 800px;
            width: 90%;
            padding: 40px 20px;
            text-align: center;
            margin: 0 auto;
        }

        h1 {
            font-size: min(8vw, 2.5rem);
            margin-bottom: 2rem;
            text-align: center;
            color: var(--primary-color);
            font-weight: 800;
            letter-spacing: -0.5px;
            -webkit-text-fill-color: var(--primary-color);
            background: none;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
                margin-bottom: 1.5rem;
            }
            
            .container {
                padding: 20px 10px;
                width: 95%;
            }
        }

        @media (orientation: landscape) {
            .container {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                align-items: center;
                max-width: 100%;
            }
            
            h1 {
                width: 100%;
                margin-bottom: 1rem;
            }
            
            .dial-container {
                width: 300px;
                height: 300px;
                margin: 0;
                flex-shrink: 0;
            }
            
            .form-container {
                width: 45%;
                margin-left: 5%;
                display: flex;
                flex-direction: column;
                align-items: center;
            }
        }

        .progress-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 18px;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2005;
            display: none;
            transition: height 0.5s ease;
            overflow: visible;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.5s linear;
            box-shadow: 0 0 10px rgba(29, 185, 84, 0.5);
            position: relative;
        }

        .progress-time {
            position: absolute;
            right: 10px;
            top: 0;
            color: var(--primary-color);
            font-weight: bold;
            font-size: 14px;
            line-height: 18px;
            opacity: 1;
            transition: opacity 0.5s ease;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.7);
        }

        .dial-container {
            margin: 30px auto;
            position: relative;
            width: 300px;
            height: 300px;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .dial {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: var(--secondary-bg);
            box-shadow: 0 0 50px rgba(29, 185, 84, 0.2);
            position: relative;
            cursor: pointer;
            border: 2px solid var(--primary-color);
            touch-action: none;
            overflow: visible;
            box-sizing: border-box;
        }

        .dial-fill {
            position: absolute;
            width: 100%;
            height: 100%;
            background: rgba(29, 185, 84, 0.15);
            border-radius: 50%;
            transform-origin: center;
            top: 0;
            left: 0;
        }

        .dial-needle {
            position: absolute;
            width: 3px;
            height: 50%;
            background: var(--primary-color);
            top: 0;
            left: 50%;
            transform-origin: bottom center;
            transform: translateX(-50%);
            border-radius: 3px;
            pointer-events: none;
            z-index: 10;
            box-shadow: 0 0 20px rgba(29, 185, 84, 0.4);
        }

        .dial-needle::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 12px;
            background: var(--primary-color);
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(29, 185, 84, 0.6);
        }

        .dial-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: min(12vw, 4.5rem);
            font-weight: 700;
            color: var(--primary-color);
            pointer-events: none;
            z-index: 10;
            text-shadow: 0 0 20px rgba(29, 185, 84, 0.4);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            letter-spacing: -1px;
            text-align: center;
        }

        .dial-markers {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 5;
        }

        .dial-marker {
            position: absolute;
            width: 2px;
            height: 12px;
            background: var(--primary-color);
            top: 0;
            left: 50%;
            margin-left: -1px;
            transform-origin: 50% 100%;
            box-shadow: 0 0 10px rgba(29, 185, 84, 0.3);
        }

        .dial-marker-label {
            position: absolute;
            color: var(--primary-color);
            font-size: min(4vw, 16px);
            font-weight: 600;
            white-space: nowrap;
            text-align: center;
            pointer-events: none;
            text-shadow: 0 0 10px rgba(29, 185, 84, 0.4);
            transform-origin: center;
            z-index: 6;
            display: flex;
            justify-content: center;
            align-items: center;
            line-height: 1;
            background: none;
            border: none;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            width: 24px;
            height: 24px;
        }

        @media (max-width: 768px) {
            .dial-container {
                width: 280px;
                height: 280px;
            }
            
            .dial-marker-label {
                font-size: 16px;
            }
            
            .dial-value {
                font-size: 3rem;
            }
        }

        .interest-input {
            width: min(90%, 400px);
            padding: 15px;
            margin: 20px auto;
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            font-size: min(4vw, 16px);
            background: var(--secondary-bg);
            color: var(--primary-color);
            transition: all 0.3s ease;
            display: block;
            text-align: center;
        }

        .interest-input::placeholder {
            color: rgba(29, 185, 84, 0.6);
        }

        .submit-btn {
            padding: 15px 40px;
            background: var(--primary-color);
            color: var(--bg-color);
            border: none;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 10px;
            box-shadow: 0 4px 10px rgba(29, 185, 84, 0.3);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(29, 185, 84, 0.4);
        }

        .submit-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .error-message {
            color: var(--primary-color);
            margin: 10px auto;
            padding: 10px;
            border-radius: 8px;
            background: rgba(29, 185, 84, 0.1);
            display: none;
            text-align: center;
            max-width: 400px;
        }

        .loading-spinner {
            display: none;
            width: 24px;
            height: 24px;
            border: 3px solid var(--secondary-bg);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            margin-left: 10px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 2000;
            display: none;
            flex-direction: column;
        }

        #videoPlayer {
            width: 100%;
            height: 100%;
            border: none;
        }

        .swipe-indicator {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: var(--primary-color);
            background: rgba(0,0,0,0.5);
            padding: 10px 20px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
            opacity: 1;
            transition: opacity 0.5s ease;
            text-align: center;
            pointer-events: none;
        }

        .swipe-indicator svg {
            margin-left: 8px;
        }

        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        .next-btn {
            position: absolute;
            bottom: 70px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 2001;
        }

        .close-btn {
            position: absolute;
            bottom: 70px;
            left: 20px;
            background: rgba(0,0,0,0.5);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2001;
        }

        .api-key-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .api-key-form {
            background: var(--secondary-bg);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
        }

        .api-key-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid var(--primary-color);
            border-radius: 8px;
            background: var(--bg-color);
            color: var(--text-color);
        }

        label {
            display: block;
            text-align: center;
            margin-bottom: 15px;
            color: var(--primary-color);
            font-size: min(5vw, 1.2rem);
            font-weight: 500;
        }

        .test-mode {
            display: none;
        }

        .time-up-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: var(--primary-color);
            padding: 2rem;
            border-radius: 15px;
            font-size: min(8vw, 2.5rem);
            font-weight: bold;
            text-align: center;
            z-index: 2002;
            display: none;
            box-shadow: 0 0 30px rgba(29, 185, 84, 0.3);
        }
    </style>
</head>
<body>
    <div class="progress-container">
        <div class="progress-bar"></div>
    </div>

    <div class="container">
        <h1>Killtime</h1>
        
        <div class="dial-container">
            <div class="dial">
                <div class="dial-fill"></div>
                <div class="dial-markers"></div>
                <div class="dial-needle"></div>
                <div class="dial-value">2:00</div>
            </div>
        </div>
        
        <div class="form-container">
            <label for="interest-input">What are you interested in watching?</label>
            <input type="text" id="interest-input" name="interest" class="interest-input" placeholder="Enter your interests (e.g., dogs, cooking, science)" value="dogs">
            <div class="error-message" role="alert"></div>
            <button class="submit-btn" type="button">
                Find Perfect Video
                <div class="loading-spinner"></div>
            </button>
        </div>
    </div>

    <div class="video-container">
        <div class="close-btn" aria-label="Close video">âœ•</div>
        <iframe id="videoPlayer" frameborder="0" allowfullscreen allow="autoplay; encrypted-media" title="YouTube video player"></iframe>
        <div class="swipe-indicator">
            Swipe up for next video
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M12 5L12 19" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M19 12L12 5L5 12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>
        <div class="next-btn" aria-label="Next video">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M5 12H19" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 5L19 12L12 19" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>
    </div>

    <div class="api-key-modal">
        <div class="api-key-form">
            <h2>API Configuration</h2>
            <form id="api-key-form">
                <label for="openaiKey">OpenAI API Key</label>
                <input type="password" id="openaiKey" name="openaiKey" class="api-key-input" placeholder="Enter your OpenAI API Key">
                <label for="youtubeKey">YouTube API Key</label>
                <input type="password" id="youtubeKey" name="youtubeKey" class="api-key-input" placeholder="Enter your YouTube API Key">
                <button type="button" id="save-keys-btn" class="submit-btn">Save Keys</button>
            </form>
        </div>
    </div>

    <div class="test-mode">Test Mode</div>

    <div class="time-up-message">Time's up!</div>

    <script>
        function createDialMarkers() {
            const dialMarkers = document.querySelector('.dial-markers');
            dialMarkers.innerHTML = '';
            
            const dialRect = document.querySelector('.dial').getBoundingClientRect();
            const dialSize = Math.min(dialRect.width, dialRect.height);
            const center = dialSize / 2;
            const labelRadius = dialSize * 0.55; // For number positions
            const markerRadius = dialSize * 0.5 - 1; // For dash positions, account for border
            
            [0, 5, 10, 15].forEach(minutes => {
                // Calculate angle in degrees (0 at top, clockwise)
                const angle = (minutes / 15) * 360 - 90;
                const angleRad = (angle * Math.PI) / 180;
                
                // Create marker line (dash)
                const marker = document.createElement('div');
                marker.className = 'dial-marker';
                
                // Position marker at the edge
                marker.style.position = 'absolute';
                marker.style.top = '50%';
                marker.style.left = '50%';
                marker.style.height = '12px';
                marker.style.width = '2px';
                marker.style.transformOrigin = 'center bottom';
                marker.style.transform = `rotate(${angle}deg) translateY(-${markerRadius}px)`;
                
                // Create and position label (number)
                const labelDiv = document.createElement('div');
                labelDiv.className = 'dial-marker-label';
                labelDiv.textContent = minutes;
                
                // Calculate label position
                const x = Math.cos(angleRad) * labelRadius;
                const y = Math.sin(angleRad) * labelRadius;
                
                // Position label
                labelDiv.style.position = 'absolute';
                labelDiv.style.top = `${center + y}px`;
                labelDiv.style.left = `${center + x}px`;
                labelDiv.style.transform = 'translate(-50%, -50%)';
                
                // Larger text for 0 and 15
                if (minutes === 0 || minutes === 15) {
                    labelDiv.style.fontSize = '18px';
                    labelDiv.style.fontWeight = '700';
                }
                
                dialMarkers.appendChild(marker);
                dialMarkers.appendChild(labelDiv);
            });
        }

        // Create markers initially
        createDialMarkers();

        // Recreate markers when window is resized or orientation changes
        window.addEventListener('resize', createDialMarkers);
        window.addEventListener('orientationchange', createDialMarkers);

        // Store keys with SameSite attribute
        function setLocalStorageWithFallback(key, value) {
            try {
                localStorage.setItem(key, value);
            } catch (e) {
                console.error('Error saving to localStorage:', e);
                // Fallback to cookies with SameSite attribute
                document.cookie = `${key}=${value}; SameSite=Lax; Secure; max-age=31536000; path=/`;
            }
        }

        function getStoredValue(key, defaultValue) {
            try {
                const localValue = localStorage.getItem(key);
                if (localValue) return localValue;
                
                // Try to get from cookies if localStorage fails
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(key + '=')) {
                        return cookie.substring(key.length + 1);
                    }
                }
                return defaultValue;
            } catch (e) {
                console.error('Error accessing storage:', e);
                return defaultValue;
            }
        }

        // Global variables to track progress
        let dialValue = 120; // 2 minutes in seconds (default)
        const dial = document.querySelector('.dial');
        const dialNeedle = document.querySelector('.dial-needle');
        const dialDisplay = document.querySelector('.dial-value');
        const dialFill = document.querySelector('.dial-fill');
        const interestInput = document.getElementById('interest-input');
        const submitBtn = document.querySelector('.submit-btn');
        const videoContainer = document.querySelector('.video-container');
        const videoPlayer = document.querySelector('#videoPlayer');
        const progressContainer = document.querySelector('.progress-container');
        const progressBar = document.querySelector('.progress-bar');
        const closeBtn = document.querySelector('.close-btn');
        const nextBtn = document.querySelector('.next-btn');
        let isRotating = false;
        let startAngle = 0;
        let currentInterest = '';
        let progressInterval;
        let touchStartY = 0;
        let touchEndY = 0;
        let swipeTimeout;
        let elapsedTime = 0; // Track elapsed time globally

        // Initialize the dial
        createDialMarkers();
        updateDialNeedle();
        updateDialFill();

        // Check for API keys - only show modal if YouTube key is not set
        if (!getStoredValue('youtubeKey', '') || getStoredValue('youtubeKey', '') === "YOUR_YOUTUBE_API_KEY") {
            document.querySelector('.api-key-modal').style.display = 'flex';
        }

        function saveApiKeys() {
            const openaiKey = document.getElementById('openaiKey').value;
            const youtubeKey = document.getElementById('youtubeKey').value;
            
            if (youtubeKey) {
                setLocalStorageWithFallback('openaiKey', openaiKey);
                setLocalStorageWithFallback('youtubeKey', youtubeKey);
                document.querySelector('.api-key-modal').style.display = 'none';
            } else {
                alert('Please enter a YouTube API key');
            }
        }

        // Connect the save button to the saveApiKeys function
        document.getElementById('save-keys-btn').addEventListener('click', saveApiKeys);

        // Handle dial rotation for mouse events
        dial.addEventListener('mousedown', initRotation);
        document.addEventListener('mousemove', rotate);
        document.addEventListener('mouseup', () => isRotating = false);

        // Handle dial rotation for touch events
        dial.addEventListener('touchstart', initTouchRotation);
        dial.addEventListener('touchmove', touchRotate);
        dial.addEventListener('touchend', () => isRotating = false);

        function initRotation(e) {
            isRotating = true;
            const rect = dial.getBoundingClientRect();
            const center = {
                x: rect.left + rect.width / 2,
                y: rect.top + rect.height / 2
            };
            startAngle = Math.atan2(e.clientY - center.y, e.clientX - center.x) * (180 / Math.PI);
        }

        function initTouchRotation(e) {
            isRotating = true;
            const rect = dial.getBoundingClientRect();
            const center = {
                x: rect.left + rect.width / 2,
                y: rect.top + rect.height / 2
            };
            const touch = e.touches[0];
            startAngle = Math.atan2(touch.clientY - center.y, touch.clientX - center.x) * (180 / Math.PI);
            e.preventDefault();
        }

        function rotate(e) {
            if (!isRotating) return;
            
            const rect = dial.getBoundingClientRect();
            const center = {
                x: rect.left + rect.width / 2,
                y: rect.top + rect.height / 2
            };
            
            // Calculate the current angle in degrees
            const currentAngle = Math.atan2(e.clientY - center.y, e.clientX - center.x) * (180 / Math.PI);
            
            // Calculate the angle difference, handling the wrap-around at +/- 180 degrees
            let angleDiff = currentAngle - startAngle;
            if (angleDiff > 180) angleDiff -= 360;
            if (angleDiff < -180) angleDiff += 360;
            
            // Make the dial more responsive by scaling the angle difference
            const secondsChange = angleDiff * 5;
            
            // Calculate new value with improved precision
            let newValue = dialValue + secondsChange;
            
            // Snap to 0 if very close
            if (newValue < 15) {
                newValue = 0;
            } else {
                // Round to nearest 5 seconds for smoother movement
                newValue = Math.max(0, Math.min(900, Math.round(newValue / 5) * 5));
            }
            
            // Only update if the value has changed
            if (newValue !== dialValue) {
                dialValue = newValue;
                updateDialDisplay();
                updateDialNeedle();
                updateDialFill();
            }
            
            // Reset the start angle for the next movement
            startAngle = currentAngle;
        }

        function touchRotate(e) {
            if (!isRotating) return;
            
            const rect = dial.getBoundingClientRect();
            const center = {
                x: rect.left + rect.width / 2,
                y: rect.top + rect.height / 2
            };
            
            const touch = e.touches[0];
            const currentAngle = Math.atan2(touch.clientY - center.y, touch.clientX - center.x) * (180 / Math.PI);
            
            let angleDiff = currentAngle - startAngle;
            if (angleDiff > 180) angleDiff -= 360;
            if (angleDiff < -180) angleDiff += 360;
            
            const secondsChange = angleDiff * 5;
            
            let newValue = dialValue + secondsChange;
            
            // Snap to 0 if very close
            if (newValue < 15) {
                newValue = 0;
            } else {
                // Round to nearest 5 seconds for smoother movement
                newValue = Math.max(0, Math.min(900, Math.round(newValue / 5) * 5));
            }
            
            if (newValue !== dialValue) {
                dialValue = newValue;
                updateDialDisplay();
                updateDialNeedle();
                updateDialFill();
            }
            
            startAngle = currentAngle;
            e.preventDefault();
        }

        function updateDialDisplay() {
            const minutes = Math.floor(dialValue / 60);
            const seconds = dialValue % 60;
            // Always show two digits for minutes and seconds
            dialDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateDialNeedle() {
            // Map 0-900 seconds to 0-360 degrees
            // 900 seconds (15 minutes) = 360 degrees
            const degrees = (dialValue / 900) * 360;
            dialNeedle.style.transform = `translateX(-50%) rotate(${degrees}deg)`;
        }

        function updateDialFill() {
            const fillPercentage = dialValue / 900;
            const dialFill = document.querySelector('.dial-fill');
            
            if (fillPercentage <= 0) {
                dialFill.style.background = 'transparent';
                return;
            }
            
            if (fillPercentage >= 1) {
                dialFill.style.background = 'rgba(29, 185, 84, 0.15)';
                dialFill.style.clipPath = 'none';
                return;
            }
            
            // Use conic-gradient for more reliable fill
            const angle = fillPercentage * 360;
            
            dialFill.style.background = `conic-gradient(
                from -90deg,
                rgba(29, 185, 84, 0.15) 0deg ${angle}deg,
                transparent ${angle}deg 360deg
            )`;
            
            // Ensure the fill is properly clipped to a circle
            dialFill.style.clipPath = 'none';
        }

        // Handle swipe up for next video
        videoContainer.addEventListener('touchstart', function(e) {
            touchStartY = e.changedTouches[0].screenY;
        }, false);
        
        videoContainer.addEventListener('touchend', function(e) {
            touchEndY = e.changedTouches[0].screenY;
            handleSwipe();
        }, false);
        
        function handleSwipe() {
            if (touchStartY - touchEndY > 50) { // Swipe up
                getNextVideo();
                
                // Show swipe indicator briefly when swiped
                const swipeIndicator = document.querySelector('.swipe-indicator');
                swipeIndicator.style.opacity = '1';
                
                // Clear any existing timeout
                clearTimeout(swipeTimeout);
                
                // Hide after 2 seconds
                swipeTimeout = setTimeout(() => {
                    swipeIndicator.style.opacity = '0';
                }, 2000);
            }
        }

        // Close video button
        closeBtn.addEventListener('click', () => {
            videoContainer.style.display = 'none';
            progressContainer.style.display = 'none';
            clearInterval(progressInterval);
            videoPlayer.src = ''; // Clear the iframe source when closing
            
            // Reset progress bar height for next time
            progressContainer.style.height = '18px';
            const progressTime = document.querySelector('.progress-time');
            if (progressTime) {
                progressTime.style.opacity = '1';
            }
        });

        // Next video button
        nextBtn.addEventListener('click', getNextVideo);

        function startProgressBar() {
            elapsedTime = 0; // Reset elapsed time when starting fresh
            progressBar.style.width = '0%';
            progressContainer.style.display = 'block';
            
            // Create or update the time display
            let progressTime = document.querySelector('.progress-time');
            if (!progressTime) {
                progressTime = document.createElement('div');
                progressTime.className = 'progress-time';
                progressContainer.appendChild(progressTime);
            }
            
            // Start with larger height
            progressContainer.style.height = '18px';
            progressTime.style.opacity = '1';
            
            // Format time remaining
            const formatTimeRemaining = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };
            
            // Update time display
            progressTime.textContent = formatTimeRemaining(dialValue - elapsedTime);
            
            // Schedule the shrink after 4 seconds
            setTimeout(() => {
                progressContainer.style.height = '6px';
                progressTime.style.opacity = '0';
            }, 4000);
            
            clearInterval(progressInterval);
            progressInterval = setInterval(() => {
                elapsedTime++;
                const percentage = (elapsedTime / dialValue) * 100;
                progressBar.style.width = `${percentage}%`;
                
                // Update time remaining
                progressTime.textContent = formatTimeRemaining(dialValue - elapsedTime);
                
                if (elapsedTime >= dialValue) {
                    clearInterval(progressInterval);
                    showTimeUpMessage();
                }
            }, 1000);
        }

        function continueProgressBar() {
            // Don't reset elapsed time, just continue from where we left off
            progressContainer.style.display = 'block';
            
            // Create or update the time display
            let progressTime = document.querySelector('.progress-time');
            if (!progressTime) {
                progressTime = document.createElement('div');
                progressTime.className = 'progress-time';
                progressContainer.appendChild(progressTime);
            }
            
            // Start with larger height
            progressContainer.style.height = '18px';
            progressTime.style.opacity = '1';
            
            // Format time remaining
            const formatTimeRemaining = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };
            
            // Update time display
            progressTime.textContent = formatTimeRemaining(dialValue - elapsedTime);
            
            // Schedule the shrink after 4 seconds
            setTimeout(() => {
                progressContainer.style.height = '6px';
                progressTime.style.opacity = '0';
            }, 4000);
            
            clearInterval(progressInterval);
            progressInterval = setInterval(() => {
                elapsedTime++;
                const percentage = (elapsedTime / dialValue) * 100;
                progressBar.style.width = `${percentage}%`;
                
                // Update time remaining
                progressTime.textContent = formatTimeRemaining(dialValue - elapsedTime);
                
                if (elapsedTime >= dialValue) {
                    clearInterval(progressInterval);
                    showTimeUpMessage();
                }
            }, 1000);
        }

        function showTimeUpMessage() {
            const timeUpMessage = document.querySelector('.time-up-message');
            timeUpMessage.style.display = 'block';
            timeUpMessage.textContent = dialValue === 0 ? "Time to be great, go!" : "Time's up!";
            
            // Hide the message after 3 seconds and close the video
            setTimeout(() => {
                timeUpMessage.style.display = 'none';
                closeBtn.click();
            }, 3000);
        }

        function getNextVideo() {
            if (currentInterest) {
                // Don't reset progress bar when getting next video
                fetchVideo(currentInterest, false);
            }
        }

        async function fetchVideo(interest, resetProgress = true) {
            const errorMessage = document.querySelector('.error-message');
            const loadingSpinner = document.querySelector('.loading-spinner');
            const swipeIndicator = document.querySelector('.swipe-indicator');
            
            try {
                submitBtn.disabled = true;
                loadingSpinner.style.display = 'inline-block';
                
                let openaiKey, youtubeKey;
                openaiKey = getStoredValue('openaiKey', '');
                youtubeKey = getStoredValue('youtubeKey', '');
                
                if (!youtubeKey) {
                    throw new Error('YouTube API key not found. Please configure your API keys.');
                }
                
                // STANDALONE MODE - No server required
                // 1. First, create a search query based on the interest
                const searchQuery = await createSearchQuery(interest);
                
                // 2. Then search YouTube directly
                const video = await searchYouTube(searchQuery, youtubeKey, dialValue);
                
                if (video && video.id) {
                    // Reset swipe indicator to visible
                    swipeIndicator.style.opacity = '1';
                    
                    videoContainer.style.display = 'flex';
                    // Use embed URL format with origin parameter to help with cross-origin issues
                    videoPlayer.src = `https://www.youtube.com/embed/${video.id}?autoplay=1&enablejsapi=1&origin=${window.location.origin}`;
                    errorMessage.style.display = 'none';
                    
                    // Start or continue progress bar
                    if (resetProgress) {
                        startProgressBar();
                    } else {
                        continueProgressBar();
                    }
                    
                    // Clear any existing timeout
                    clearTimeout(swipeTimeout);
                    
                    // Hide swipe indicator after 2 seconds
                    swipeTimeout = setTimeout(() => {
                        swipeIndicator.style.opacity = '0';
                    }, 2000);
                } else {
                    throw new Error('No suitable videos found. Please try a different interest.');
                }
            } catch (error) {
                console.error('Error:', error);
                errorMessage.textContent = error.message;
                errorMessage.style.display = 'block';
                videoContainer.style.display = 'none';
                // Don't hide progress container when there's an error
            } finally {
                submitBtn.disabled = false;
                loadingSpinner.style.display = 'none';
            }
        }
        
        // Create a search query based on the interest
        async function createSearchQuery(interest) {
            // For simplicity, we'll just add some keywords to make the search more specific
            const minutes = Math.floor(dialValue / 60);
            const keywords = [
                'guide', 'tutorial', 'how to', 'explanation', 'tips', 
                'facts about', 'information', 'learn about'
            ];
            
            // Pick a random keyword to combine with the interest
            const randomKeyword = keywords[Math.floor(Math.random() * keywords.length)];
            
            // Create query with minutes but without explicitly mentioning "english"
            // The relevanceLanguage parameter in the API call will handle language filtering
            return `${interest} ${randomKeyword} ${minutes} minutes`;
        }
        
        // Search YouTube directly
        async function searchYouTube(query, apiKey, targetDuration) {
            try {
                // First, search for videos matching the query
                const searchUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=video&videoEmbeddable=true&videoSyndicated=true&maxResults=20&relevanceLanguage=en&key=${apiKey}`;
                const searchResponse = await fetch(searchUrl);
                const searchData = await searchResponse.json();
                
                if (!searchResponse.ok) {
                    throw new Error(searchData.error?.message || 'YouTube API error');
                }
                
                if (!searchData.items || searchData.items.length === 0) {
                    throw new Error('No videos found matching your interest. Please try a different topic.');
                }
                
                // Get video IDs from search results
                const videoIds = searchData.items.map(item => item.id.videoId).join(',');
                
                // Get detailed information about these videos
                const detailsUrl = `https://www.googleapis.com/youtube/v3/videos?part=contentDetails,statistics,status,snippet&id=${videoIds}&key=${apiKey}`;
                const detailsResponse = await fetch(detailsUrl);
                const detailsData = await detailsResponse.json();
                
                if (!detailsResponse.ok) {
                    throw new Error(detailsData.error?.message || 'YouTube API error');
                }
                
                // Combine search results with video details and filter for embeddable videos
                const videos = [];
                searchData.items.forEach(searchItem => {
                    const videoDetails = detailsData.items.find(item => item.id === searchItem.id.videoId);
                    
                    if (videoDetails && videoDetails.status.embeddable !== false) {
                        const duration = parseDuration(videoDetails.contentDetails.duration);
                        
                        // Skip videos longer than the selected time
                        if (duration > targetDuration) {
                            return;
                        }
                        
                        // Check if video is in English (either by snippet.defaultAudioLanguage or defaultLanguage)
                        // but don't filter out videos with no language specified
                        const videoLanguage = videoDetails.snippet.defaultAudioLanguage || videoDetails.snippet.defaultLanguage || '';
                        const isEnglish = !videoLanguage || videoLanguage.startsWith('en');
                        
                        // Skip non-English videos if we can detect the language
                        if (videoLanguage && !isEnglish) {
                            return;
                        }
                        
                        // Skip videos that are specifically about learning English language
                        const title = videoDetails.snippet.title.toLowerCase();
                        const description = videoDetails.snippet.description.toLowerCase();
                        if ((title.includes('learn english') || title.includes('english lesson') || 
                             title.includes('english class') || title.includes('english course')) &&
                            (description.includes('learn english') || description.includes('english lesson') || 
                             description.includes('english grammar') || description.includes('english vocabulary'))) {
                            return;
                        }
                        
                        const viewCount = parseInt(videoDetails.statistics.viewCount || '0');
                        
                        // Calculate relevance score based on duration match and view count
                        const durationDiff = Math.abs(duration - targetDuration);
                        const durationScore = Math.max(0, 1 - (durationDiff / targetDuration));
                        const viewScore = Math.min(1, Math.log10(viewCount + 1) / 7);
                        const relevanceScore = (durationScore * 0.7) + (viewScore * 0.3);
                        
                        videos.push({
                            id: searchItem.id.videoId,
                            title: searchItem.snippet.title,
                            channelTitle: searchItem.snippet.channelTitle,
                            duration: duration,
                            viewCount: viewCount,
                            relevanceScore: relevanceScore,
                            language: videoLanguage
                        });
                    }
                });
                
                if (videos.length === 0) {
                    throw new Error('No suitable videos found. Try a different interest or increase the time.');
                }
                
                // Sort by relevance score (highest first)
                videos.sort((a, b) => b.relevanceScore - a.relevanceScore);
                
                // Return the best match
                return videos[0];
            } catch (error) {
                console.error('YouTube search error:', error);
                throw error;
            }
        }
        
        // Parse YouTube duration format (PT1H30M15S) to seconds
        function parseDuration(duration) {
            const match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
            const hours = (match[1] || '0H').slice(0, -1);
            const minutes = (match[2] || '0M').slice(0, -1);
            const seconds = (match[3] || '0S').slice(0, -1);
            return (parseInt(hours) * 3600) + (parseInt(minutes) * 60) + parseInt(seconds);
        }

        submitBtn.addEventListener('click', async () => {
            const interest = interestInput.value.trim();
            const errorMessage = document.querySelector('.error-message');
            
            errorMessage.style.display = 'none';
            
            if (!interest) {
                errorMessage.textContent = 'Please enter your interests';
                errorMessage.style.display = 'block';
                return;
            }

            // Check if time is 0
            if (dialValue === 0) {
                videoContainer.style.display = 'flex';
                showTimeUpMessage();
                return;
            }

            const youtubeKey = getStoredValue('youtubeKey', '');

            if (!youtubeKey || youtubeKey === "YOUR_YOUTUBE_API_KEY") {
                document.querySelector('.api-key-modal').style.display = 'flex';
                return;
            }

            currentInterest = interest;
            fetchVideo(interest, true); // Reset progress when starting a new search
        });
    </script>
</body>
</html>
